#
# This action runs everytime a PR is merged into the "main" or "develop" branches.
#
# It automatically bumps packages version if needed.
# - stable version if main branch
# - prerelease if develop branch
# It then creates tags, creates GitHub releases and publishes the packages that did change.
#
# Example
#
# packages/libA depends on packages/libB
# libA package.json should have its prod dependencies as:
# "dependencies": {
#   "libB": "workspace:../libB" <- using pnpm workspace concept
# }
#
# Secenario #1
# libA does not change, but libB does, then both versions will
# be updated and both packages will be published.
#
# Secenario #2
# libA does change, and libB does not, then only libA version will
# be updated and only libA package will be published.
#

name: Bump and Publish

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - development

jobs:
  publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: "https://registry.npmjs.org"

      - name: Version Bump
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          corepack enable
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor}}@users.noreply.github.com"

          if [ ${{ github.base_ref }} = development ]; then
            npx lerna version --conventional-commits --conventional-prerelease --preid beta --yes
          else
            npx lerna version --conventional-commits --conventional-graduate --create-release github --yes
          fi

      - name: Publish Packages
        env:
          NODE_AUTH_TOKEN: ${{secrets.NPM_PUBLISH_TOKEN}}
        run: |
          corepack enable
          npx lerna publish from-package --no-push --no-private --yes --loglevel debug
